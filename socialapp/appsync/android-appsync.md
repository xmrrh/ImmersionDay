---
title: "Write a post "
chapter: false
date: 2018-08-07T08:30:11-07:00
weight: 11
---

Now let's integrate it with the Write Activity for posting.

Add classpath to dependencies in build.gradle (Module: Project) as shown below.

```java
classpath 'com.amazonaws:aws-android-sdk-appsync-gradle-plugin:2.9.+'
```



Apply the plugin to build.gradle (Module: app). Copy and paste the following at the top of build.gradle (Module: app). The code is automatically generated by this plugin.

```java
apply plugin: 'com.amazonaws.appsync' 
```



Note that when adding apply plugin: 'com.amazonaws.appsync', you may encounter com.amazonaws.appsync not found issues due to sync issues. After adding classpath 'com.amazonaws: aws-android-sdk-appsync-gradle-plugin: 2.9. +', sync it once, and then apply plugin to it.


Also add 4 implementations to dependencies in the same file, build.gradle (Module: app), as below.


```java
dependencies {
...
implementation 'com.amazonaws:aws-android-sdk-appsync:2.9.+'
implementation 'org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.2.0'
implementation 'org.eclipse.paho:org.eclipse.paho.android.service:1.1.1'
implementation 'com.amazonaws:aws-android-sdk-s3:2.14.+'
...
}
```



Next, to reuse the frequently used AWSAppSyncClient, create a ClientFactory class as shown below.

![c9after](/images/clientfactory.png)

ClientFactory.java 
```java
package com.example.socialandroidapp;

import android.content.Context;
import android.util.Log;

import com.amazonaws.auth.AWSCredentials;
import com.amazonaws.auth.AWSCredentialsProvider;
import com.amazonaws.auth.CognitoCachingCredentialsProvider;
import com.amazonaws.mobile.client.AWSMobileClient;
import com.amazonaws.mobile.config.AWSConfiguration;
import com.amazonaws.mobileconnectors.appsync.AWSAppSyncClient;
import com.amazonaws.mobileconnectors.appsync.S3ObjectManagerImplementation;
import com.amazonaws.mobileconnectors.appsync.sigv4.CognitoUserPoolsAuthProvider;
import com.amazonaws.regions.Region;
import com.amazonaws.services.s3.AmazonS3Client;

public class ClientFactory {

    private static AWSAppSyncClient mAWSAppSyncClient;

    public static void appSyncInit(Context context) {
        if (mAWSAppSyncClient == null) {
            mAWSAppSyncClient = AWSAppSyncClient.builder()
                    .context(context)
                    .awsConfiguration(new AWSConfiguration(context))
                    .cognitoUserPoolsAuthProvider(new CognitoUserPoolsAuthProvider() {
                        @Override
                        public String getLatestAuthToken() {
                            try {

                                return AWSMobileClient.getInstance().getTokens().getIdToken().getTokenString();
                            } catch (Exception e) {
                                Log.e("APPSYNC_ERROR", e.getLocalizedMessage());
                                return e.getLocalizedMessage();
                            }
                        }
                    }).s3ObjectManager(getS3ObjectManager(context)).build();

        }
    }

    public static AWSAppSyncClient getAppSyncClient() {
        return mAWSAppSyncClient;
    }

    private static S3ObjectManagerImplementation s3ObjectManager;

    // Copy the below two methods and add the .s3ObjectManager builder parameter
    // initialize and fetch the S3 Client
    public static S3ObjectManagerImplementation getS3ObjectManager(final Context context) {
        if (s3ObjectManager == null) {


            AmazonS3Client s3Client = new AmazonS3Client(ClientFactory.getCredentialsProvider(context));
            s3Client.setRegion(Region.getRegion("us-east-1")); // you can set the region of bucket here
            s3ObjectManager = new S3ObjectManagerImplementation(s3Client);
        }
        return s3ObjectManager;
    }

    // initialize and fetch cognito credentials provider for S3 Object Manager
    public static AWSCredentialsProvider getCredentialsProvider(final Context context) {
        CognitoCachingCredentialsProvider credentialsProvider = new CognitoCachingCredentialsProvider(
                context, AWSMobileClient.getInstance().getConfiguration()
        );
        return credentialsProvider;
    }

    public static String getUserID() {
        return AWSMobileClient.getInstance().getUsername();
    }

    public static AWSCredentials getAWSCredentials()  {
        AWSCredentials awsCredentials = null;
        try {
            awsCredentials = AWSMobileClient.getInstance().getAWSCredentials();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return awsCredentials;
    }
}

```

Create an AWSAppSyncClient using the ClientFactory created above in the onCreate function of WriteActivity.java. 

Add ClientFactory.appSyncInit (..) to onCreate () as shown below.

```java
  @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.write);
        //appsync
        ClientFactory.appSyncInit(getApplicationContext());
        ...
  }
```



Add the **addComment** function to WriteActivity.java. Pressing the **DONE** button calls the addComment function, which uploads the post to the repository. Copy and paste the source and replace the <b> putYourBucketName variable with <span style = "color: red"> your S3 bucket name </span> </b>

```java
     //appsync upload
 private final String putYourBucketName = "putYourBucketName";
 private final String mimeType = "image/jpg";
 private final String region = "us-east-1";
 private final String folderName = "public/";
 
 private void addComment() {

        showWaitDialog();

        S3ObjectInput s3ObjectInput = S3ObjectInput.builder()
                .bucket(putYourBucketName)
                .key(folderName + UUID.randomUUID().toString())
                .region(region)
                .localUri(bitmapPath)
                .mimeType(mimeType).build();
        PutPostWithPhotoMutation addPostMutation = PutPostWithPhotoMutation.builder()
                .title(title.getText().toString())
                .author(ClientFactory.getUserID())
                .url(bitmapPath)
                .content(contents.getText().toString())
                .uptime(String.valueOf(System.currentTimeMillis()))
                .photo(s3ObjectInput)
                .id("DEV-DAY")
                .build();



        ClientFactory.getAppSyncClient().mutate(addPostMutation).enqueue(postsCallback);
    }

    private GraphQLCall.Callback<PutPostWithPhotoMutation.Data> postsCallback = new GraphQLCall.Callback<PutPostWithPhotoMutation.Data>() {
        @Override
        public void onResponse(@Nonnull final Response<PutPostWithPhotoMutation.Data> response) {
            runOnUiThread(new Runnable() {
                @Override
                public void run() {
                    dismissWaitDialog();
                    WriteActivity.this.finish();
                }
            });
        }

        @Override
        public void onFailure(@Nonnull final ApolloException e) {
            runOnUiThread(new Runnable() {
                @Override
                public void run() {
                    dismissWaitDialog();

                    Log.e("", "Failed to perform AddPostMutation", e);
                    WriteActivity.this.finish();
                }
            });
        }
    };
```



Import the required class.

```java
import com.amazonaws.amplify.generated.graphql.PutPostWithPhotoMutation;
import com.apollographql.apollo.GraphQLCall;
import com.apollographql.apollo.api.Response;
import com.apollographql.apollo.exception.ApolloException;
import type.S3ObjectInput;
import javax.annotation.Nonnull;
import android.util.Log;

```


This function can be called on saveBtn's onClick event.
Delete the existing code, WriteActivity.this.finish (), and add addComment () instead.

```java
  @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.write);
        //appsync
        ClientFactory.appSyncInit(getApplicationContext());        
        ...
        saveBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (bitmapPath == null) {
                    Toast.makeText(getApplicationContext(), getString(R.string.warning_picture), Toast.LENGTH_SHORT).show();
                    return;
                }

                //WriteActivity.this.finish();
                addComment();

            }
        });
        ...
  }
```


Press **Run button** at the top of your Android Studio project to run the application with the emulator you have already created.

![c9after](/images/run.png)

The executed screen is as follows.

![c9after](/images/signin_eng.png)

When you log in, you will see an empty list screen as shown below.

![c9after](/images/emptylist.png)

Press the Write button to move to the post creation screen, compose and upload a photo as shown below, and press **done** button.

<b> If you installed the emulator for the first time, there are no pictures to choose from. Go to the Camera app and take a picture of the dummy and you can select it. </b>



After a while, you will be taken to an empty list screen.

![c9after](/images/writesample.png)


